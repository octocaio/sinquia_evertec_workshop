name: ğŸš€ Build e Deploy no GitHub Pages

# Executa o workflow em push para main e pull requests
on:
  push:
    branches: [ main, master ]
  pull_request:
    types: [ opened, synchronize, reopened ]
    branches: [ main, master ]
  
  # Permite execuÃ§Ã£o manual do workflow
  workflow_dispatch:

# Define permissÃµes necessÃ¡rias para o GitHub Pages e comentÃ¡rios
permissions:
  contents: read
  pages: write
  id-token: write
  issues: write
  pull-requests: write

# Garante que apenas um deployment rode por vez
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job para validaÃ§Ã£o e testes
  validate:
    name: ğŸ” ValidaÃ§Ã£o e Testes
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ“¦ Instalar dependÃªncias de desenvolvimento
      run: |
        npm init -y
        npm install --save-dev html-validate htmlhint stylelint stylelint-config-standard eslint
        
    - name: âœ… Validar HTML
      run: |
        # Verifica se os arquivos HTML sÃ£o vÃ¡lidos
        npx html-validate location-app/*.html || echo "âš ï¸ Aviso: Problemas menores de HTML detectados"
        
    - name: âœ… Validar CSS
      run: |
        # Verifica sintaxe CSS
        npx stylelint "location-app/**/*.css" --allow-empty-input || echo "âš ï¸ Aviso: Problemas menores de CSS detectados"
        
    - name: âœ… Validar JavaScript
      run: |
        # Verifica sintaxe JavaScript
        npx eslint location-app/**/*.js --no-eslintrc --parser-options=ecmaVersion:2020 || echo "âš ï¸ Aviso: Problemas menores de JS detectados"
        
    - name: ğŸ§ª Verificar estrutura de arquivos
      run: |
        echo "ğŸ“‚ Verificando estrutura do projeto..."
        ls -la location-app/
        
        # Verifica se arquivos essenciais existem
        if [ ! -f "location-app/index.html" ]; then
          echo "âŒ Erro: index.html nÃ£o encontrado!"
          exit 1
        fi
        
        if [ ! -f "location-app/styles.css" ]; then
          echo "âŒ Erro: styles.css nÃ£o encontrado!"
          exit 1
        fi
        
        if [ ! -f "location-app/script.js" ]; then
          echo "âŒ Erro: script.js nÃ£o encontrado!"
          exit 1
        fi
        
        echo "âœ… Todos os arquivos essenciais estÃ£o presentes!"

  # Job para build e otimizaÃ§Ã£o
  build:
    name: ğŸ”¨ Build da AplicaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ“¦ Instalar ferramentas de build
      run: |
        npm init -y
        npm install --save-dev html-minifier-terser clean-css-cli terser
        
    - name: ğŸ“ Criar diretÃ³rio de build
      run: mkdir -p dist
      
    - name: ğŸ¯ Copiar arquivos para build
      run: |
        cp -r location-app/* dist/
        
    - name: ğŸ—œï¸ Minificar HTML
      run: |
        npx html-minifier-terser \
          --input-dir dist \
          --output-dir dist \
          --file-ext html \
          --collapse-whitespace \
          --remove-comments \
          --remove-redundant-attributes \
          --use-short-doctype \
          --minify-css true \
          --minify-js true
          
    - name: ğŸ—œï¸ Minificar CSS
      run: |
        npx cleancss -o dist/styles.css dist/styles.css
        
    - name: ğŸ—œï¸ Minificar JavaScript
      run: |
        npx terser dist/script.js -o dist/script.js --compress --mangle --toplevel
        
    - name: ğŸ“Š Exibir estatÃ­sticas de build
      run: |
        echo "ğŸ“ˆ EstatÃ­sticas do build:"
        echo "ğŸ“‚ Arquivos na pasta dist:"
        ls -lah dist/
        echo ""
        echo "ğŸ“ Tamanhos dos arquivos:"
        du -h dist/*
        
    - name: ğŸ” Verificar integridade dos arquivos
      run: |
        echo "ğŸ” Verificando integridade..."
        
        # Verifica se HTML ainda Ã© vÃ¡lido
        if [ ! -s "dist/index.html" ]; then
          echo "âŒ Erro: index.html estÃ¡ vazio apÃ³s minificaÃ§Ã£o!"
          exit 1
        fi
        
        # Verifica se CSS ainda Ã© vÃ¡lido
        if [ ! -s "dist/styles.css" ]; then
          echo "âŒ Erro: styles.css estÃ¡ vazio apÃ³s minificaÃ§Ã£o!"
          exit 1
        fi
        
        # Verifica se JS ainda Ã© vÃ¡lido
        if [ ! -s "dist/script.js" ]; then
          echo "âŒ Erro: script.js estÃ¡ vazio apÃ³s minificaÃ§Ã£o!"
          exit 1
        fi
        
        echo "âœ… Todos os arquivos foram processados corretamente!"
        
    - name: ğŸ“¤ Upload dos artefatos de build
      uses: actions/upload-artifact@v4
      with:
        name: built-app
        path: dist/
        retention-days: 30

  # Job para deploy no GitHub Pages (apenas em push para main)
  deploy:
    name: ğŸŒ Deploy no GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    environment:
      name: github-pages
      
    steps:
    - name: ğŸ“¥ Download dos artefatos
      uses: actions/download-artifact@v4
      with:
        name: built-app
        path: dist/
        
    - name: ğŸ”§ Configurar GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: ğŸ“¤ Upload para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: dist/
        
    - name: ğŸš€ Deploy no GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: âœ… Deploy concluÃ­do
      run: |
        echo "ğŸ‰ Deploy realizado com sucesso!"
        echo "ğŸŒ URL da aplicaÃ§Ã£o: ${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "ğŸ“‹ Resumo do deploy:"
        echo "â€¢ Branch: ${{ github.ref_name }}"
        echo "â€¢ Commit: ${{ github.sha }}"
        echo "â€¢ Autor: ${{ github.actor }}"
        echo "â€¢ Workflow: ${{ github.run_number }}"

  # Job para comentar no PR (apenas em pull requests)
  pr-comment:
    name: ğŸ’¬ ComentÃ¡rio no PR
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    continue-on-error: true  # NÃ£o falha o workflow se o comentÃ¡rio falhar
    
    steps:
    - name: ğŸ“ Comentar no Pull Request
      uses: actions/github-script@v7
      continue-on-error: true  # Permite que o step falhe sem afetar outros jobs
      with:
        script: |
          const { owner, repo, number } = context.issue;
          
          const comment = `## ğŸš€ Build ConcluÃ­do com Sucesso!
          
          âœ… **ValidaÃ§Ã£o**: Arquivos HTML, CSS e JS verificados
          âœ… **Build**: AplicaÃ§Ã£o compilada e otimizada
          âœ… **MinificaÃ§Ã£o**: Arquivos comprimidos para melhor performance
          
          ### ğŸ“Š InformaÃ§Ãµes do Build:
          - **Commit**: \`${context.sha.substring(0, 7)}\`
          - **Branch**: \`${context.ref.replace('refs/heads/', '')}\`
          - **Workflow**: #${context.runNumber}
          
          ### ğŸ” PrÃ³ximos Passos:
          ApÃ³s o merge desta PR, a aplicaÃ§Ã£o serÃ¡ automaticamente deployada no GitHub Pages.
          
          ---
          ğŸ¤– _ComentÃ¡rio automÃ¡tico do GitHub Actions_`;
          
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: comment
          });
